<div class="horario-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title class="title-center">Registro de Asistencia</mat-card-title>
    </mat-card-header>
  </mat-card>

  <mat-card class="date-selector-card">
    <mat-card-content>
      <div class="date-controls">
        <mat-form-field appearance="outline">
          <mat-label>Seleccionar fecha</mat-label>
          <input 
            matInput 
            type="date" 
            [(ngModel)]="selectedDate"
            (change)="onDateChange()"
            [max]="maxDate">
        </mat-form-field>
        <button mat-raised-button color="primary" (click)="setHoy()">
          HOY
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="grupoInfo" class="info-card">
    <mat-card-content>
      <div class="info-content">
        <h2>{{ diaActual }} - {{ selectedDate }}</h2>
        <p>Grupo: {{ grupoInfo.name }} - Aula: {{ grupoInfo.aula }} - Edificio: {{ grupoInfo.edificio }}</p>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="loading" class="loading-card">
    <mat-card-content>
      <div class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="!loading && diaActual && horasNecesarias.length > 0" class="table-card">
    <table mat-table [dataSource]="getHorarioArray()" class="horario-table">
      <!-- Columna Hora -->
      <ng-container matColumnDef="hora">
        <th mat-header-cell *matHeaderCellDef class="header-hora">Hora</th>
        <td mat-cell *matCellDef="let horario" class="cell-hora">
          {{ formatHora(horario.hora_inicio) }}
        </td>
      </ng-container>

      <!-- Columna Día Actual -->
      <ng-container matColumnDef="dia">
        <th mat-header-cell *matHeaderCellDef class="header-dia">{{ diaActual }}</th>
        <td mat-cell *matCellDef="let horario" class="cell-dia" [class.has-class]="horario.materia">
          <div class="horario-info" *ngIf="horario.materia">
            <div class="materia-nombre">{{ horario.materia }}</div>
            <div class="maestro-info">Maestro: {{ horario.maestro }}</div>
            <div 
              class="estado-info" 
              [ngClass]="{
                'estado-presente': horario.asistencia === 'Presente',
                'estado-ausente': horario.asistencia === 'Falta',
                'estado-retardo': horario.asistencia === 'Retardo',
                'estado-pendiente': horario.asistencia === 'pendiente'
              }">
              Estado: {{ horario.asistencia }}
            </div>
            <div class="botones-asistencia">
              <button 
                mat-raised-button 
                color="primary"
                [class.selected]="horario.asistencia === 'Presente'"
                (click)="handleToggleAsistencia(horario.dia, horario.hora_inicio, 'Presente')"
                class="btn-presente"
              >
                Presente
              </button>
              <button 
                mat-raised-button 
                color="warn"
                [class.selected]="horario.asistencia === 'Falta'"
                (click)="handleToggleAsistencia(horario.dia, horario.hora_inicio, 'Falta')"
                class="btn-ausente"
              >
                Falta
              </button>
              <button 
                mat-raised-button 
                color="accent"
                [class.selected]="horario.asistencia === 'Retardo'"
                (click)="handleToggleAsistencia(horario.dia, horario.hora_inicio, 'Retardo')"
                class="btn-retardo"
              >
                Retardo
              </button>
            </div>
          </div>
          <div *ngIf="!horario.materia" class="sin-clase">
            Sin clase
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </mat-card>

  <mat-card *ngIf="!loading && !grupoInfo && !error" class="empty-card">
    <mat-card-content>
      <div class="empty-message">
        <p>No se encontró un grupo asignado a este usuario.</p>
        <p>Por favor, contacte al administrador para que le asigne un grupo.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="!loading && grupoInfo && horasNecesarias.length === 0" class="empty-card">
    <mat-card-content>
      <div class="empty-message">
        <p>No hay horarios registrados para {{ diaActual }}</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div class="alert-container">
  <div *ngIf="error" class="alert alert-danger">
    {{error}}
    <button type="button" class="btn-close" (click)="handleCloseAlert()">×</button>
  </div>
  <div *ngIf="success" class="alert alert-success">
    {{success}}
    <button type="button" class="btn-close" (click)="handleCloseAlert()">×</button>
  </div>
</div>
